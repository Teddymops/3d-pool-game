"use strict";var wireframeMaterial,createQuaternionFromAxisAngle=function(e,t){var a=new CANNON.Quaternion;return a.setFromAxisAngle(e,t),a},addCannonVisual=function(e,t){var a=void 0===t?16777215:t;wireframeMaterial=new THREE.MeshBasicMaterial({color:a,wireframe:!0});var i;e instanceof CANNON.Body&&(i=Cannonshape2mesh(e)),i&&Game.scene.add(i)},Cannonshape2mesh=function(e){for(var t=new THREE.Object3D,a=0;a<e.shapes.length;a++){var i,o=e.shapes[a];switch(o.type){case CANNON.Shape.types.SPHERE:var l=new THREE.SphereGeometry(o.radius,8,8);i=new THREE.Mesh(l,wireframeMaterial);break;case CANNON.Shape.types.PARTICLE:i=new THREE.Mesh(this.particleGeo,this.particleMaterial);var n=this.settings;i.scale.set(n.particleSize,n.particleSize,n.particleSize);break;case CANNON.Shape.types.PLANE:var s=new THREE.PlaneGeometry(10,10,4,4);i=new THREE.Object3D;var r=new THREE.Object3D,h=new THREE.Mesh(s,wireframeMaterial);h.scale.set(100,100,100),r.add(h),h.castShadow=!0,h.receiveShadow=!0,i.add(r);break;case CANNON.Shape.types.BOX:var d=new THREE.BoxGeometry(2*o.halfExtents.x,2*o.halfExtents.y,2*o.halfExtents.z);i=new THREE.Mesh(d,wireframeMaterial);break;case CANNON.Shape.types.CONVEXPOLYHEDRON:for(var c=new THREE.Geometry,m=0;m<o.vertices.length;m++){var u=o.vertices[m];c.vertices.push(new THREE.Vector3(u.x,u.y,u.z))}for(m=0;m<o.faces.length;m++)for(var p=o.faces[m],g=p[0],b=1;b<p.length-1;b++){var w=p[b],E=p[b+1];c.faces.push(new THREE.Face3(g,w,E))}c.computeBoundingSphere(),c.computeFaceNormals(),i=new THREE.Mesh(c,wireframeMaterial);break;case CANNON.Shape.types.HEIGHTFIELD:s=new THREE.Geometry;for(var N=new CANNON.Vec3,y=new CANNON.Vec3,v=new CANNON.Vec3,T=0;T<o.data.length-1;T++)for(var f=0;f<o.data[T].length-1;f++)for(var C=0;C<2;C++){o.getConvexTrianglePillar(T,f,0===C),N.copy(o.pillarConvex.vertices[0]),y.copy(o.pillarConvex.vertices[1]),v.copy(o.pillarConvex.vertices[2]),N.vadd(o.pillarOffset,N),y.vadd(o.pillarOffset,y),v.vadd(o.pillarOffset,v),s.vertices.push(new THREE.Vector3(N.x,N.y,N.z),new THREE.Vector3(y.x,y.y,y.z),new THREE.Vector3(v.x,v.y,v.z));m=s.vertices.length-3;s.faces.push(new THREE.Face3(m,m+1,m+2))}s.computeBoundingSphere(),s.computeFaceNormals(),i=new THREE.Mesh(s,wireframeMaterial);break;case CANNON.Shape.types.TRIMESH:for(s=new THREE.Geometry,N=new CANNON.Vec3,y=new CANNON.Vec3,v=new CANNON.Vec3,m=0;m<o.indices.length/3;m++){o.getTriangleVertices(m,N,y,v),s.vertices.push(new THREE.Vector3(N.x,N.y,N.z),new THREE.Vector3(y.x,y.y,y.z),new THREE.Vector3(v.x,v.y,v.z));b=s.vertices.length-3;s.faces.push(new THREE.Face3(b,b+1,b+2))}s.computeBoundingSphere(),s.computeFaceNormals(),i=new THREE.Mesh(s,wireframeMaterial);break;default:throw"Visual type not recognized: "+o.type}i.receiveShadow=!1,i.castShadow=!1;var A=e.shapeOffsets[a],B=e.shapeOrientations[a];i.position.set(A.x,A.y,A.z),i.quaternion.set(B.x,B.y,B.z,B.w),t.add(i)}return t.position.copy(e.position),t.quaternion.copy(e.quaternion),t},Arch=function(e){this.body=new CANNON.Body({mass:0,material:Table.floorContactMaterial}),e=e||{},this.position=e.position||{x:0,y:0,z:0},this.radius=e.radius||Ball.RADIUS+2,this.box_autowidth=e.box_autowidth||!1,this.box_width=e.box_width||2,this.box_height=e.box_height||5,this.box_thickness=e.box_thickness||2,this.no_of_boxes=e.no_of_boxes||5,this.body.position.set(this.position.x,this.position.y,this.position.z);var t=new CANNON.Vec3(0,1,0);this.body.quaternion.setFromAxisAngle(t,Math.PI);var a=1.2*Math.PI/(2*this.no_of_boxes),i=this.radius*Math.tan(a);this.box_autowidth||(i=this.box_width);for(var o=new CANNON.Box(new CANNON.Vec3(i,this.box_height,this.box_thickness)),l=0;l<this.no_of_boxes;l++){var n=1.2*-a+l*Math.PI*1.2/this.no_of_boxes,s=Math.cos(n),r=Math.sin(n);s*=this.radius+this.box_thickness,r*=this.radius+this.box_thickness,this.body.addShape(o,new CANNON.Vec3(s,0,r),createQuaternionFromAxisAngle(t,Math.PI/2-n))}},ShortWall=function(e,t,a,i){i-=1;this.body=new CANNON.Body({mass:0,material:Table.wallContactMaterial});var o=[0,2,-24,0,2,0,-12.5,2,-24,0,-2,-24,0,-2,0,-12.5,-2,-24],l=[0,2,-24,0,2,0,12.5,2,-24,0,-2,-24,0,-2,0,12.5,-2,-24],n=[0,1,2,3,4,5,5,0,2,5,3,0,3,4,1,3,1,0,4,5,1,5,2,1],s=new CANNON.Trimesh(o,n),r=new CANNON.Trimesh(l,n);this.body.position.set(e,t,a),this.body.addShape(s,new CANNON.Vec3(-i,0,0)),this.body.addShape(r,new CANNON.Vec3(i,0,0));var h=new CANNON.Box(new CANNON.Vec3(i,2,12));this.body.addShape(h,new CANNON.Vec3(0,0,-12)),this.body.quaternion.setFromAxisAngle(new CANNON.Vec3(0,1,0),-Math.PI/2),this.body.addEventListener("collide",function(e){})},GameGui=function(){document.getElementById("btn_ball")};GameGui.prototype.setupGameHud=function(){this.hide(document.getElementById("mainMenu")),this.show(document.getElementById("controlsHud"))},GameGui.addClass=function(e,t){e.classList?e.classList.add(t):e.className+=" "+t},GameGui.removeClass=function(e,t){e.classList?e.classList.remove(t):e.className=e.className.replace(new RegExp("(^|\\b)"+t.split(" ").join("|")+"(\\b|$)","gi")," ")},GameGui.prototype.show=function(e){GameGui.removeClass(e,"hide")},GameGui.prototype.hide=function(e){GameGui.addClass(e,"hide")},GameGui.prototype.play8BallClicked=function(){eightballgame=new EightBallGame},GameGui.prototype.UpdateTimer=function(e){},GameGui.prototype.log=function(e){document.createElement("li").textContent=e},GameGui.prototype.updateTurn=function(e){},GameGui.prototype.updateBalls=function(e,t,a){if(a="?"==a?"unknown":a,"unknown"!=(t="?"==t?"unknown":t)){for(var i=document.createElement("ul"),o=1;o<8;o++){(l=document.createElement("li")).textContent=o,-1<e.indexOf(o)||GameGui.addClass(l,"pocketed"),i.appendChild(l)}i=document.createElement("ul");for(o=9;o<16;o++){var l;(l=document.createElement("li")).textContent=o,-1<e.indexOf(o)||GameGui.addClass(l,"pocketed"),i.appendChild(l)}}},GameGui.prototype.showEndGame=function(e){document.getElementById("gameover").children[0].textContent=e+" won!",this.show(document.getElementById("gameover"))};var Table=function e(){var a=-e.LEN_X/2,i=e.LEN_Z/2,t=new THREE.JSONLoader;t.load("json/table/base.json",function(e){var t=new THREE.Mesh(e,new THREE.MeshPhongMaterial({color:new THREE.Color(0),specular:4210752,shininess:20,shading:THREE.SmoothShading}));t.position.x=a,t.position.y=0,t.position.z=i,t.scale.set(100,100,100),t.receiveShadow=!0,t.castShadow=!0,scene.add(t)}),t.load("json/table/felt.json",function(e){var t=new THREE.Mesh(e,new THREE.MeshPhongMaterial({color:new THREE.Color(TABLE_COLORS.cloth),specular:4210752,shininess:10,shading:THREE.SmoothShading}));t.position.x=a,t.position.y=0,t.position.z=i,t.scale.set(100,100,100),t.receiveShadow=!0,t.castShadow=!0,scene.add(t)}),t.load("json/table/edges.json",function(e){var t=new THREE.Mesh(e,new THREE.MeshPhongMaterial({color:new THREE.Color(8016432),specular:4210752,shininess:100,shading:THREE.SmoothShading}));t.position.x=a,t.position.y=0,t.position.z=i,t.scale.set(100,100,100),t.receiveShadow=!0,t.castShadow=!0,scene.add(t)}),t.load("json/table/pockets.json",function(e){var t=new THREE.Mesh(e,new THREE.MeshPhongMaterial({color:new THREE.Color(8016432),specular:4013373,shininess:20,shading:THREE.SmoothShading}));t.position.x=a,t.position.y=0,t.position.z=i,t.scale.set(100,100,100),t.receiveShadow=!0,t.castShadow=!0,scene.add(t)}),t.load("json/table/pocket_bottoms.json",function(e){var t=new THREE.Mesh(e,new THREE.MeshPhongMaterial({color:new THREE.Color(0),specular:0,shininess:0,shading:THREE.SmoothShading}));t.position.x=a,t.position.y=0,t.position.z=i,t.scale.set(100,100,100),t.receiveShadow=!0,t.castShadow=!0,scene.add(t)}),this.rigidBody=this.createFloor(),this.hole1=new Hole(e.LEN_X/2+1.5,0,-e.LEN_Z/2-1.5,Math.PI/4),this.hole2=new Hole(-e.LEN_X/2-1.5,0,-e.LEN_Z/2-1.5,-Math.PI/4),this.hole3=new Hole(0,0,-e.LEN_Z/2-4.8,0),this.hole4=new Hole(0,0,e.LEN_Z/2+4.8,Math.PI),this.hole5=new Hole(e.LEN_X/2+1.5,-.5,e.LEN_Z/2+1.5,3*Math.PI/4),this.hole6=new Hole(-e.LEN_X/2-1.5,-.5,e.LEN_Z/2+1.5,-3*Math.PI/4),this.walls=this.createWallBodies()},TABLE_COLORS={cloth:5085440};Table.LEN_Z=137.16,Table.LEN_X=274.32,Table.WALL_HEIGHT=6,Table.floorContactMaterial=new CANNON.Material("floorMaterial"),Table.wallContactMaterial=new CANNON.Material("wallMaterial"),Table.prototype.createWallBodies=function(){var e=new LongWall(Table.LEN_X/4-.8,2,-Table.LEN_Z/2,61),t=new LongWall(-Table.LEN_X/4+.8,2,-Table.LEN_Z/2,61);t.body.quaternion.setFromAxisAngle(new CANNON.Vec3(0,0,1),Math.PI);var a=new LongWall(Table.LEN_X/4-.8,2,Table.LEN_Z/2,61),i=new LongWall(-Table.LEN_X/4+.8,2,Table.LEN_Z/2,61);a.body.quaternion.setFromAxisAngle(new CANNON.Vec3(1,0,0),Math.PI),i.body.quaternion.setFromAxisAngle(new CANNON.Vec3(0,1,0),-Math.PI);var o=new ShortWall(Table.LEN_X/2,2,0,60.5),l=new ShortWall(-Table.LEN_X/2,2,0,60.5);l.body.quaternion.setFromAxisAngle(new CANNON.Vec3(0,1,0),-1.5*Math.PI);var n=[e,t,a,i,o,l];for(var s in n)world.addBody(n[s].body),debug&&addCannonVisual(n[s].body);return n},Table.prototype.createFloor=function(){var e=Table.LEN_Z/2-5,t=Table.LEN_X/2-4,a=new CANNON.Box(new CANNON.Vec3(t,1,Table.LEN_Z/2)),i=new CANNON.Box(new CANNON.Vec3(2,1,e));this.body=new CANNON.Body({mass:0,material:Table.floorContactMaterial}),this.body.addShape(a,new CANNON.Vec3(0,-1,0)),this.body.addShape(i,new CANNON.Vec3(-t-2,-1,0)),this.body.addShape(i,new CANNON.Vec3(t+2,-1,0)),debug&&addCannonVisual(this.body,16711680),world.add(this.body)};var Hole=function(e,t,a,i){this.arch1=new Arch({position:{x:e,y:t,z:a},no_of_boxes:8,box_height:6,box_autowidth:!0,box_thickness:.1,radius:10}),this.arch2=new Arch({position:{x:e,y:t-1,z:a},no_of_boxes:8,box_height:1,box_width:2.5,box_thickness:3,radius:10}),this.arch1.body.quaternion.setFromAxisAngle(new CANNON.Vec3(0,1,0),Math.PI-i),this.arch2.body.quaternion.setFromAxisAngle(new CANNON.Vec3(0,1,0),-i),Game.world.addBody(this.arch1.body),debug&&addCannonVisual(this.arch1.body)};function setControls(){$("#world").bind("mousemove",function(e){Game.mouseMove(e.clientX,e.clientY)}),$("#world").bind("mousedown",function(e){e.preventDefault(),0===e.button&&Game.mouseClick(e.clientX,e.clientY)}),$("#world").bind("mouseup",function(e){e.preventDefault(),0===e.button&&Game.mouseUp(e.clientX,e.clientY)});var e=document.getElementById("world");e.addEventListener("touchstart",function(e){Game.mouseClick(e.changedTouches[0].clientX,e.changedTouches[0].clientY)},!1),e.addEventListener("touchend",function(e){Game.mouseUp(e.changedTouches[0].clientX,e.changedTouches[0].clientY)},!1),e.addEventListener("touchmove",function(e){Game.mouseMove(e.changedTouches[0].clientX,e.changedTouches[0].clientY)},!1)}var Ball=function e(t,a,i,o,l){this.color=void 0===l?13369344:l,this.texture=o,this.mesh=this.createMesh(t,a,i),this.sphere=new THREE.Sphere(this.mesh.position,e.RADIUS),Game.scene.add(this.mesh),this.rigidBody=this.createBody(t,a,i),this.rigidBody.addEventListener("collide",function(e){}),Game.world.addBody(this.rigidBody),this.name=o,this.fallen=!1};Ball.RADIUS=3.518075,Ball.MASS=.17,Ball.contactMaterial=new CANNON.Material("ballMaterial"),Ball.prototype.onEnterHole=function(){this.rigidBody.velocity=new CANNON.Vec3(0),this.rigidBody.angularVelocity=new CANNON.Vec3(0),Game.world.removeBody(this.rigidBody),this.mesh.visible=!1,this.dropped=!0,eightballgame&&eightballgame.coloredBallEnteredHole(this.name)},Ball.prototype.createBody=function(e,t,a){var i=new CANNON.Body({mass:Ball.MASS,position:new CANNON.Vec3(e,t,a),shape:new CANNON.Sphere(Ball.RADIUS),material:Ball.contactMaterial});return i.linearDamping=i.angularDamping=.5,i.allowSleep=!0,i.sleepSpeedLimit=.5,i.sleepTimeLimit=.1,i},Ball.prototype.createMesh=function(e,t,a){var i=Game.ballGeo,o=new THREE.MeshPhongMaterial({specular:16777215,shininess:140,reflectivity:.1,combine:THREE.AddOperation});o.map=Game.ballTextures[this.texture];var l=new THREE.Mesh(i,o);return l.position.set(e,t,a),l.castShadow=!0,l.receiveShadow=!0,l},Ball.prototype.tick=function(e){this.mesh.position.copy(this.rigidBody.position),this.mesh.quaternion.copy(this.rigidBody.quaternion),this.rigidBody.position.y<-4*Ball.RADIUS&&!this.fallen&&(this.fallen=!0,Game.mute||this.mute||document.getElementById("dropcue09").play(),this.onEnterHole())};var Bot=function(){console.log("bot")};Bot.prototype={construct:Bot,turn:function(){if("gameover"!=eightballgame.state){var e;switch(eightballgame.sides.player2){case"?":e=this.getHitPoint();break;case"solid":e=this.getHitPoint("solid");break;case"striped":e=this.getHitPoint("striped")}var t=new THREE.Vector3;t.copy(e).sub(Game.mainBall.mesh.position),t.y=-15,t.normalize(),Game.mainBall.forward.copy(t),Game.mainBall.hitForward(100);var a=.5<Math.random()?"hitcue05":"hitcue06";Game.mute||document.getElementById(a).play(),eightballgame.hitButtonClicked();var i=Math.atan2(t.x,t.z);Game.cam_rot[2]=180*(i+90)/Math.PI,this.inAim=0,Game.cue.position.z=0}},getHitPoint:function(e){console.log("ballsType",e);var t,a,i,o=Game.balls,l=new THREE.Vector3,n=this.getHolls();for(var s in o)if(!o[s].dropped&&(!e||"solid"==e&&s<8||"striped"==e&&8<s||"8"==e&&8==s))for(var r in n)i=o[s].mesh.position.distanceTo(n[r]),(!t||i<t)&&(t=i,l.copy(n[r]),a=o[s]);var h=new THREE.Vector3;if(!a)for(var r in a=o[8],n)i=a.mesh.position.distanceTo(n[r]),(!t||i<t)&&(t=i,l.copy(n[r]));return h.copy(a.mesh.position).sub(l).normalize().multiplyScalar(1.9*Ball.RADIUS).add(a.mesh.position),h},getHolls:function(){return[new THREE.Vector3(Table.LEN_X/2+1.5,0,-Table.LEN_Z/2-1.5,Math.PI/4),new THREE.Vector3(-Table.LEN_X/2-1.5,0,-Table.LEN_Z/2-1.5,-Math.PI/4),new THREE.Vector3(0,0,-Table.LEN_Z/2-4.8,0),new THREE.Vector3(0,0,Table.LEN_Z/2+4.8,Math.PI),new THREE.Vector3(Table.LEN_X/2+1.5,0,Table.LEN_Z/2+1.5,3*Math.PI/4),new THREE.Vector3(-Table.LEN_X/2-1.5,0,Table.LEN_Z/2+1.5,-3*Math.PI/4)]},aim:function(){if("gameover"!=eightballgame.state){var e;switch(eightballgame.sides.player2){case"?":e=this.getHitPoint();break;case"solid":e=this.getHitPoint("solid");break;case"striped":e=this.getHitPoint("striped")}var t=new THREE.Vector3;t.copy(e).sub(Game.mainBall.mesh.position),t.y=-15,t.normalize();var a=180*-Math.atan2(t.x,t.z)/Math.PI-90;Game.cam_rot[eightballgame.getPlayerId()]=a,Game.updateCam(),this.inAim=1,Game.cue.position.z=0}}};var LongWall=function(e,t,a,i){var o=5.5;this.body=new CANNON.Body({mass:0,material:Table.wallContactMaterial});var l=[0,3,0,0,3,-11,-3.9,3,0,0,-3,0,0,-3,-11,-3.9,-3,0],n=[0,3,-11,0,3,0,7,3,-11,0,-3,-11,0,-3,0,7,-3,-11],s=[0,1,2,3,4,5,5,0,2,5,3,0,3,4,1,3,1,0,4,5,1,5,2,1],r=new CANNON.Trimesh(l,s),h=new CANNON.Trimesh(n,s);this.body.position.set(e,t,a),this.body.addShape(r,new CANNON.Vec3(4-i,0,0)),this.body.addShape(h,new CANNON.Vec3(i,0,0));var d=new CANNON.Box(new CANNON.Vec3(i-2,3,o));this.body.addShape(d,new CANNON.Vec3(2,0,-o)),this.body.addEventListener("collide",function(e){})},EightBallGame=function(){this.numbered_balls_on_table=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],this.turn="player1",this.sides={player1:"?",player2:"?"},this.hitCount=0,this.timeouts=[],this.stripedDrop=[],this.solidDrop=[],this.escStriped=[],this.escSolid=[],this.pocketingOccurred=!1,this.state="notstarted",this.ticker=void 0,gui.setupGameHud(),this.hols=[],this.hols.push(new THREE.Vector3(Table.LEN_X/2+5.7,0,-Table.LEN_Z/2-5.4)),this.hols.push(new THREE.Vector3(-Table.LEN_X/2-5.7,0,-Table.LEN_Z/2-5)),this.hols.push(new THREE.Vector3(0,0,-Table.LEN_Z/2-6.9)),this.hols.push(new THREE.Vector3(0,0,Table.LEN_Z/2+6.9)),this.hols.push(new THREE.Vector3(Table.LEN_X/2+5.7,0,Table.LEN_Z/2+5.4)),this.hols.push(new THREE.Vector3(-Table.LEN_X/2-5.7,0,Table.LEN_Z/2+5.4)),this.timeouts.push(setTimeout(this.startTurn,2e3))};EightBallGame.prototype.startTurn=function(){eightballgame&&"gameover"!=eightballgame.state&&(eightballgame.timer=30,eightballgame.state="turn",gui.updateTurn(eightballgame.turn),this.hitCount++,gui.updateBalls(eightballgame.numbered_balls_on_table,eightballgame.sides.player1,eightballgame.sides.player2),0===Game.curMode&&"player2"==eightballgame.turn&&Game.bot.turn(),eightballgame.tickTimer())},EightBallGame.prototype.whiteBallEnteredHole=function(){console.log("White ball pocketed by "+eightballgame.turn+"!"),eightballgame.pocketingOccurred=!1,Game.mainBall.fallen=!1},EightBallGame.prototype.getPlayerId=function(){return"player1"==this.turn?1:2},EightBallGame.prototype.getOpId=function(){return"player2"==this.turn?1:2},EightBallGame.prototype.coloredBallEnteredHole=function(e){if(console.log("colored ball enter hole",e),void 0!==e){var t;if(t=e,eightballgame.numbered_balls_on_table.splice(t-1,1),"main"!=t){var a=Game.balls[e],i=!1,o=(new THREE.Vector3).copy(a.mesh.position);for(var l in o.y=0,this.hols)if(o.distanceTo(this.hols[l])<3*Ball.RADIUS){i=!0;break}if(!i)return eightballgame.pocketingOccurred=!1,void(8==t?(eightballgame.turn="player1"==eightballgame.turn?"player2":"player1",eightballgame.endGame()):t<8?(this.solidDrop.push(t),this.escSolid.push(t),console.log("esc solid")):(this.stripedDrop.push(t),this.escStriped.push(t),console.log("esc striped")));8==t?(("?"==eightballgame.sides.player1||"solid"==eightballgame.sides[eightballgame.turn]&&this.solidDrop.length<7||"striped"==eightballgame.sides[eightballgame.turn]&&this.stripedDrop.length<7)&&(gui.log("Game over! 8 ball pocketed too early by "+this.turn),eightballgame.turn="player1"==eightballgame.turn?"player2":"player1"),eightballgame.pocketingOccurred=!0,eightballgame.endGame()):(t<8?this.solidDrop.push(t):this.stripedDrop.push(t),"?"==eightballgame.sides.player1?(eightballgame.sides[eightballgame.turn]=t<8?"solid":"striped",eightballgame.sides["player1"==eightballgame.turn?"player2":"player1"]=8<t?"solid":"striped",eightballgame.pocketingOccurred=!0):"solid"==eightballgame.sides[eightballgame.turn]&&t<8||"striped"==eightballgame.sides[eightballgame.turn]&&8<t?Game.mainBall.droped?eightballgame.pocketingOccurred=!1:eightballgame.pocketingOccurred=!0:(eightballgame.pocketingOccurred=!1,console.log(eightballgame.turn+" pocketed opponent's ball!")),console.log("update balls gui"),Game.updateBallsGui())}}},EightBallGame.prototype.tickTimer=function(){gui.UpdateTimer(eightballgame.timer)},EightBallGame.prototype.switchSides=function(){eightballgame.turn="player1"==eightballgame.turn?"player2":"player1",console.log("switch",eightballgame.turn),Game.mainBall.respown&&(Game.cam_rot[this.getPlayerId()]=180+Math.random()),0===Game.curMode&&"player2"==eightballgame.turn&&Game.bot.aim(),this.timeouts.push(setTimeout(eightballgame.startTurn,1e3))},EightBallGame.prototype.endGame=function(){eightballgame.state="gameover";eightballgame.turn;clearTimeout(eightballgame.ticker),Game.over(eightballgame.turn)},EightBallGame.prototype.hitButtonClicked=function(e){console.log(eightballgame.state),"turn"==eightballgame.state&&(clearTimeout(eightballgame.ticker),eightballgame.state="turnwaiting",this.hitInt=setInterval(function(){var e=!0;for(var t in Game.balls)if(Game.balls[t].mesh.visible&&Game.balls[t].rigidBody.sleepState!=CANNON.Body.SLEEPING){e=!1;break}e&&Game.mainBall.rigidBody.sleepState==CANNON.Body.SLEEPING&&(eightballgame.pocketingOccurred?(0===Game.curMode&&"player2"==eightballgame.turn&&Game.bot.aim(),eightballgame.timeouts.push(setTimeout(eightballgame.startTurn,1e3))):eightballgame.switchSides(),eightballgame.pocketingOccurred=!1,clearInterval(eightballgame.hitInt))},30))};var WhiteBall=function(e,t,a){this.color=16777215,this.defaultPosition=new CANNON.Vec3(-Table.LEN_X/4,Ball.RADIUS,0),Ball.call(this,this.defaultPosition.x,this.defaultPosition.y,this.defaultPosition.z,"whiteball",this.color),this.respown=!0,this.forward=new THREE.Vector3(1,0,0),this.forwardLine=this.createForwardLine(),Game.scene.add(this.forwardLine)};WhiteBall.prototype=Object.create(Ball.prototype),(WhiteBall.prototype.constructor=WhiteBall).prototype.hitForward=function(e){this.rigidBody.wakeUp();var t=new CANNON.Vec3;t.copy(this.rigidBody.position);var a=new CANNON.Vec3;a.copy(this.forward),a.normalize(),a.scale(Ball.RADIUS,a),t.vsub(a,t);var i=new CANNON.Vec3;i.copy(this.forward.normalize()),i.scale(e,i),this.rigidBody.applyImpulse(i,t),this.respown=!1,this.droped=!1},WhiteBall.prototype.onEnterHole=function(){this.rigidBody.velocity=new CANNON.Vec3(0),this.rigidBody.angularVelocity=new CANNON.Vec3(0),this.respown=!0,this.droped=!0,this.rigidBody.position.y=-5*Ball.RADIUS,this.mesh.position.y=-5*Ball.RADIUS;var e=!0;for(var t in Game.balls)if(Game.balls[t].mesh.visible&&Game.balls[t].rigidBody.sleepState!=CANNON.Body.SLEEPING){e=!1;break}e?(this.mute=!1,this.rigidBody.position.copy(this.defaultPosition),eightballgame.whiteBallEnteredHole()):(this.mute=!0,this.fallen=!1)},WhiteBall.prototype.tick=function(e){Ball.prototype.tick.apply(this,arguments);var t=!0;for(var a in Game.balls){if(Game.balls[a].mesh.visible&&Game.balls[a].rigidBody.sleepState!=CANNON.Body.SLEEPING){t=!1;break}if(Game.balls[a].mesh.visible&&3.6<Game.balls[a].mesh.position.y){if(8==Game.balls[a].name)return Game.balls[a].mesh.visible=!1,eightballgame.turn="player1"==eightballgame.turn?"player2":"player1",void eightballgame.endGame();Game.balls[a].name<8?(eightballgame.escSolid.push(Game.balls[a].name),Game.balls[a].dropped=!0,Game.balls[a].mesh.visible=!1,eightballgame.solidDrop.push(Game.balls[a].name),console.log("esc solid")):(eightballgame.escStriped.push(Game.balls[a].name),Game.balls[a].dropped=!0,Game.balls[a].mesh.visible=!1,eightballgame.stripedDrop.push(Game.balls[a].name),console.log("esc striped")),eightballgame.pocketingOccurred=!1}}t&&this.rigidBody.sleepState==CANNON.Body.SLEEPING&&"gameover"!=eightballgame.state?(this.forwardLine.visible||(this.forwardLine.visible=!0),this.active=!1,Game.cueWrap.visible=!0,0===Game.curMode&&2==eightballgame.getPlayerId()?(this.updateGuideLine(!0),$("#hitRound, #roundDummy").hide()):(this.updateGuideLine(),this.updateIntersectionDot(),$("#hitRound, #roundDummy").show())):(this.active=!0,this.forwardLine.visible&&(this.forwardLine.visible=!1),$("#hitRound, #roundDummy").hide(),Game.cueWrap.visible=!1)},WhiteBall.prototype.createIntersectionDot=function(){var e=new THREE.SphereGeometry(1,4,4),t=new THREE.MeshBasicMaterial({opacity:.5,transparent:!0,color:16776960});return new THREE.Mesh(e,t)},WhiteBall.prototype.updateIntersectionDot=function(){},WhiteBall.prototype.updateGuideLine=function(){var e=-Game.cam_rot[eightballgame.getPlayerId()]*Math.PI/180+Math.PI;this.forward.set(Math.cos(e),0,-Math.sin(e)),this.forwardLine.position.copy(this.mesh.position),this.forwardLine.rotation.y=e,this.forward.normalize();var t=[];for(var a in Game.balls)t.push({index:a,dist:Math.abs(this.mesh.position.distanceTo(Game.balls[a].mesh.position))});t.sort(function(e,t){return e.dist-t.dist});for(var i=-1,o=0;o<t.length;o++){var l=t[o].index,n=Game.balls[l];if(this.forwardLine.ray.intersectsSphere(n.sphere)){i=l;break}}this.intersectionPoint=-1==i?this.forwardLine.ray.intersectBox(this.forwardLine.box):this.forwardLine.ray.intersectSphere(Game.balls[i].sphere);var s=Math.sqrt(this.mesh.position.distanceToSquared(this.intersectionPoint));this.forwardLine.geometry.vertices[1].x=s,this.forwardLine.geometry.verticesNeedUpdate=!0};var eightballgame,gui,debug=!(WhiteBall.prototype.createForwardLine=function(){var e=new THREE.Geometry,t=e.vertices;t.push(new THREE.Vector3(0,0,0)),t.push(new THREE.Vector3(85,0,0)),e.computeLineDistances();var a=new THREE.LineDashedMaterial({color:14540253,dashSize:4,gapSize:2,linewidth:3}),i=new THREE.Line(e,a);return i.position.copy(new THREE.Vector3(100,100,100)),i.box=new THREE.Box3(new THREE.Vector3(-Table.LEN_X/2,0,-Table.LEN_Z/2),new THREE.Vector3(Table.LEN_X/2,2*Ball.RADIUS,Table.LEN_Z/2)),i.ray=new THREE.Ray(this.mesh.position,this.forward),i}),Game={cols:[],rc:new THREE.Raycaster,gameField:new Array,curTurn:1,curMode:0,gameOver:!1,balls:{},arrowPlace:0,controls:!1,mute:!1,loadingcount:6,cam_rot:{1:180+Math.random(),2:180+Math.random()},rotate:!1,hit:!1,mousePos:{x:0,y:0},cueShift:0,prevCueShift:0,ballTextures:{},curMousePos:new THREE.Vector2,cueTrace:[],stat:new Image,init:function(){this.stat.src="http://lisgames.ru/stat.jpg",this.world=new CANNON.World,this.world.gravity.set(0,-294.6,0),this.world.solver.iterations=10,this.world.solver.tolerance=0,this.world.allowSleep=!0,this.world.defaultContactMaterial.friction=.1,this.world.defaultContactMaterial.restitution=.85;var e=new CANNON.ContactMaterial(Ball.contactMaterial,Table.floorContactMaterial,{friction:.7,restitution:.1}),t=new CANNON.ContactMaterial(Ball.contactMaterial,Table.wallContactMaterial,{friction:.5,restitution:.9});this.world.addContactMaterial(e),this.world.addContactMaterial(t),this.renderer=new THREE.WebGLRenderer({antialias:!0}),this.renderer.autoClear=!1,device.mobile()||device.tablet()?this.renderer.shadowMap.enabled=!1:(this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=THREE.PCFSoftShadowMap);this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(65,$("#world").width()/$("#world").height(),10,1e3),this.camera.position.set(0,150,68),this.camera.lookAt(new THREE.Vector3(0,0,18)),this.scene.add(this.camera),this.scene2=new THREE.Scene;var a=new THREE.SpotLight(16777189,1);a.position.set(0,120,0),a.target.position.set(0,0,0),a.target.updateMatrixWorld(),a.castShadow=!0,a.shadowCameraFov=110,a.shadowCameraNear=10,a.shadowCameraFar=170,a.shadowMapWidth=1024,a.shadowMapHeight=1024,a.penumbra=.5,this.scene.add(a),a.target.updateMatrixWorld();var i=a.clone();i.castShadow=!1,this.scene2.add(i),this.scene.add(new THREE.AmbientLight(7829367)),this.scene2.add(new THREE.AmbientLight(7829367)),this.clock=new THREE.Clock,$("#world").append(this.renderer.domElement),this.resize(),window.addEventListener("resize",this.resize.bind(this),!1),device.mobile()||device.tablet()?(this.texture=(new THREE.TextureLoader).load("data/dif1024.jpg",this.loaded.bind(this)),this.lightMap=(new THREE.TextureLoader).load("data/lightMap.jpg",this.loaded.bind(this))):this.texture=(new THREE.TextureLoader).load("data/bill_Material__2_AlbedoTransparency.jpg",this.loaded.bind(this)),device.mobile()||device.tablet()||(this.normal=(new THREE.TextureLoader).load("data/bill_Material__2_Normal.png",this.loaded.bind(this)),this.texture.anisotropy=8,this.normal.anisotropy=8),this.cueTexture=(new THREE.TextureLoader).load("data/Cue.jpg",this.loaded.bind(this));for(var o=["#FEED01","#182983","#E53118","#93117E","#EF7F01","#00914E","#871421","#000000","#FEED01","#182983","#E53118","#93117E","#EF7F01","#00914E","#871421"],l=($("#ballsplace").height(),1);l<16;l++){var n=document.createElement("canvas");if(n.getContext){var s=n.getContext("2d");s.canvas.width=256,s.canvas.height=256,s.fillStyle="#FFFFFF",s.fillRect(0,0,256,256),s.fillStyle=o[l-1];var r=0;8<l&&(r=40),s.fillRect(0,0+r,256,256-2*r);var h=n.width/2,d=n.height/2;s.beginPath(),s.arc(h,d,60,0,2*Math.PI,!1),s.fillStyle="#FFFFFF",s.fill(),s.fillStyle="#000000",s.font="76px Tahoma",s.textBaseline="middle",s.textAlign="center",s.fillText(l,128,128),this.ballTextures[l]=new THREE.Texture(n),this.ballTextures[l].anisotropy=16,this.ballTextures[l].needsUpdate=!0}}this.resizeBallsGui();var c=new THREE.OBJLoader;device.mobile()||device.tablet()?c.load("data/bill2.obj",function(e){console.log(e),e.children[0].geometry.center(),e.children[0].geometry.attributes.uv2=e.children[0].geometry.attributes.uv;var t=["varying vec3 v_FragmentPosition;"].join("\n"),a=["varying vec3 v_FragmentPosition;","uniform vec3 balls_pos [16];","const vec3  shadowColor = vec3( 0.1, 0.1, 0.1 );"].join("\n"),i=["\tvec4 worldPosition = modelMatrix * vec4( position, 1.0 );","\tv_FragmentPosition = worldPosition.xyz;"].join("\n"),o=["\tfloat distance = 65534.0;","   float cur_distance = 0.0;","   vec3 L = vec3(0, 0, 0);","\tfor ( int i = 0; i < 16; i ++ ) {","\t\tL = balls_pos[i] - v_FragmentPosition;","\t\tcur_distance = length( L );","\t\tdistance = min(distance, cur_distance);","\t}","\tfloat shadowAttenuation = 1.0 - smoothstep( 0.0, 5.5, distance );","\tgl_FragColor.rgb =  mix( gl_FragColor.rgb, shadowColor, shadowAttenuation );"].join("\n"),l=["#define USE_MAP","#define USE_LIGHTMAP",THREE.ShaderLib.basic.vertexShader].join("\n");l=(l=l.replace("#include <fog_pars_vertex>",t)).replace("#include <fog_vertex>",i);var n=["#define USE_MAP","#define USE_LIGHTMAP",THREE.ShaderLib.basic.fragmentShader].join("\n");n=(n=n.replace("#include <fog_pars_fragment>",a)).replace("#include <fog_fragment>",o);var s=THREE.UniformsUtils.merge([THREE.ShaderLib.basic.uniforms,{balls_pos:{type:"v3v",value:[new THREE.Vector3(-500,0,-500),new THREE.Vector3(-500,0,-500),new THREE.Vector3(-500,0,-500),new THREE.Vector3(-500,0,-500),new THREE.Vector3(-500,0,-500),new THREE.Vector3(-500,0,-500),new THREE.Vector3(-500,0,-500),new THREE.Vector3(-500,0,-500),new THREE.Vector3(-500,0,-500),new THREE.Vector3(-500,0,-500),new THREE.Vector3(-500,0,-500),new THREE.Vector3(-500,0,-500),new THREE.Vector3(-500,0,-500),new THREE.Vector3(-500,0,-500),new THREE.Vector3(-500,0,-500),new THREE.Vector3(-500,0,-500)]}}]);Game.balls_pos=s.balls_pos,s.map.value=Game.texture,s.lightMap.value=Game.lightMap;var r=new THREE.ShaderMaterial({vertexShader:l,fragmentShader:n,uniforms:s,lights:!1});e.children[0].material=r,e.scale.set(.429,.425,.421),e.position.y=-28.6,Game.scene.add(e);var h=new CANNON.Box(new CANNON.Vec3(131,1,Table.LEN_Z/2-1)),d=new CANNON.Box(new CANNON.Vec3(2,1,67)),c=new CANNON.Box(new CANNON.Vec3(4,1,65)),m=new CANNON.Box(new CANNON.Vec3(4,1,73)),u=new CANNON.Body({mass:0,material:Table.floorContactMaterial});u.addShape(h,new CANNON.Vec3(0,-1,0)),u.addShape(d,new CANNON.Vec3(-133,-1,0)),u.addShape(d,new CANNON.Vec3(133,-1,0)),u.addShape(c,new CANNON.Vec3(-137,-1,0)),u.addShape(c,new CANNON.Vec3(137,-1,0)),u.addShape(m,new CANNON.Vec3(-129,-1,0)),u.addShape(m,new CANNON.Vec3(129,-1,0)),debug&&addCannonVisual(u,16711680),Game.world.add(u);new Hole(Table.LEN_X/2+5.7,0,-Table.LEN_Z/2-5.4,Math.PI/4),new Hole(-Table.LEN_X/2-5.7,0,-Table.LEN_Z/2-5.4,-Math.PI/4),new Hole(0,0,-Table.LEN_Z/2-6.9,0),new Hole(0,0,Table.LEN_Z/2+6.9,Math.PI),new Hole(Table.LEN_X/2+5.7,0,Table.LEN_Z/2+5.4,3*Math.PI/4),new Hole(-Table.LEN_X/2-5.7,0,Table.LEN_Z/2+5.4,-3*Math.PI/4);var p=new LongWall(Table.LEN_X/4-.8,2,-Table.LEN_Z/2,61),g=new LongWall(-Table.LEN_X/4+.8,2,-Table.LEN_Z/2,61);g.body.quaternion.setFromAxisAngle(new CANNON.Vec3(0,0,1),Math.PI);var b=new LongWall(Table.LEN_X/4-.8,2,Table.LEN_Z/2,61),w=new LongWall(-Table.LEN_X/4+.8,2,Table.LEN_Z/2,61);b.body.quaternion.setFromAxisAngle(new CANNON.Vec3(1,0,0),Math.PI),w.body.quaternion.setFromAxisAngle(new CANNON.Vec3(0,1,0),-Math.PI);var E=new ShortWall(Table.LEN_X/2,2,0,60.5),N=new ShortWall(-Table.LEN_X/2,2,0,60.5);N.body.quaternion.setFromAxisAngle(new CANNON.Vec3(0,1,0),-1.5*Math.PI);var y=[p,g,b,w,E,N];for(var v in y)Game.world.addBody(y[v].body),debug&&addCannonVisual(y[v].body);Game.loaded(),Game.render(),gui=new GameGui}):c.load("data/bill.obj",function(e){e.children[0].geometry.center(),e.children[0].material=new THREE.MeshStandardMaterial({map:Game.texture,normalMap:Game.normal,metalness:0,roughness:.8}),e.children[0].castShadow=!0,e.children[0].receiveShadow=!0,e.castShadow=!0,e.scale.set(.429,.425,.421),e.position.y=-28.6,Game.scene.add(e);var t=new CANNON.Box(new CANNON.Vec3(131,1,Table.LEN_Z/2-1)),a=new CANNON.Box(new CANNON.Vec3(2,1,67)),i=new CANNON.Box(new CANNON.Vec3(4,1,65)),o=new CANNON.Box(new CANNON.Vec3(4,1,73)),l=new CANNON.Body({mass:0,material:Table.floorContactMaterial});l.addShape(t,new CANNON.Vec3(0,-1,0)),l.addShape(a,new CANNON.Vec3(-133,-1,0)),l.addShape(a,new CANNON.Vec3(133,-1,0)),l.addShape(i,new CANNON.Vec3(-137,-1,0)),l.addShape(i,new CANNON.Vec3(137,-1,0)),l.addShape(o,new CANNON.Vec3(-129,-1,0)),l.addShape(o,new CANNON.Vec3(129,-1,0)),debug&&addCannonVisual(l,16711680),Game.world.add(l);new Hole(Table.LEN_X/2+5.7,0,-Table.LEN_Z/2-5.4,Math.PI/4),new Hole(-Table.LEN_X/2-5.7,0,-Table.LEN_Z/2-5.4,-Math.PI/4),new Hole(0,0,-Table.LEN_Z/2-6.9,0),new Hole(0,0,Table.LEN_Z/2+6.9,Math.PI),new Hole(Table.LEN_X/2+5.7,0,Table.LEN_Z/2+5.4,3*Math.PI/4),new Hole(-Table.LEN_X/2-5.7,0,Table.LEN_Z/2+5.4,-3*Math.PI/4);var n=new LongWall(Table.LEN_X/4-.8,2,-Table.LEN_Z/2,61),s=new LongWall(-Table.LEN_X/4+.8,2,-Table.LEN_Z/2,61);s.body.quaternion.setFromAxisAngle(new CANNON.Vec3(0,0,1),Math.PI);var r=new LongWall(Table.LEN_X/4-.8,2,Table.LEN_Z/2,61),h=new LongWall(-Table.LEN_X/4+.8,2,Table.LEN_Z/2,61);r.body.quaternion.setFromAxisAngle(new CANNON.Vec3(1,0,0),Math.PI),h.body.quaternion.setFromAxisAngle(new CANNON.Vec3(0,1,0),-Math.PI);var d=new ShortWall(Table.LEN_X/2,2,0,60.5),c=new ShortWall(-Table.LEN_X/2,2,0,60.5);c.body.quaternion.setFromAxisAngle(new CANNON.Vec3(0,1,0),-1.5*Math.PI);var m=[n,s,r,h,d,c];for(var u in m)Game.world.addBody(m[u].body),debug&&addCannonVisual(m[u].body);Game.loaded(),Game.render(),gui=new GameGui}),(new THREE.OBJLoader).load("data/ball.obj",function(e){e.children[0].geometry.center(),Game.ballGeo=e.children[0].geometry,Game.loaded()}),(new THREE.OBJLoader).load("data/cue.obj",function(e){e.children[0].geometry.center(),e.children[0].scale.set(1.5,1.5,1.5),e.children[0].position.z=-23,e.children[0].material=new THREE.MeshPhongMaterial({map:Game.cueTexture}),Game.cue=e,Game.cueWrap.add(e),Game.loaded()}),this.cueWrap=new THREE.Group,this.scene2.add(this.cueWrap),console.log(THREE.ShaderLib)},render:function(){requestAnimationFrame(this.render.bind(this));var e=this.clock.getDelta();if(this.updateCam(),eightballgame&&"gameover"!=eightballgame.state)for(var t in this.mainBall&&eightballgame&&(this.mainBall.tick(e),this.balls_pos&&(this.balls_pos.value[0].copy(this.mainBall.mesh.position),this.balls_pos.value[0].y=0)),this.balls)this.balls[t].tick(e),this.balls_pos&&(this.balls_pos.value[t].copy(this.balls[t].mesh.position),this.balls_pos.value[t].y=0);if(eightballgame&&"gameover"!=eightballgame.state&&this.bot&&this.bot.inAim&&(1==this.bot.inAim?(this.cue.position.z-=10*e,this.cue.position.z<-9&&(this.bot.inAim=2)):this.cue.position.z+=120*e),this.renderer.render(this.scene,this.camera),this.renderer.clearDepth(),this.renderer.render(this.scene2,this.camera),this.world.step(1/60),eightballgame&&"gameover"!==eightballgame.state){if(0===this.curMode)if(1===eightballgame.getPlayerId()){var a="";"?"!=eightballgame.sides.player1&&(a="solid"==eightballgame.sides.player1?"(Solid)":"(Striped)"),$("#curTurn").text("Player "+a)}else{var i="";"?"!=eightballgame.sides.player2&&(i="solid"==eightballgame.sides.player2?"(Solid)":"(Striped)"),$("#curTurn").text("Robot "+i)}else{var o="";"?"!=eightballgame.sides[eightballgame.turn]&&(o="solid"==eightballgame.sides[eightballgame.turn]?" (Solid)":" (Striped)"),$("#curTurn").text("Player "+eightballgame.getPlayerId()+o)}"?"!=eightballgame.sides.player1?1===eightballgame.getPlayerId()?($("#player1balls, #player1escBalls").show(),$("#player2balls, #player2escBalls").hide()):($("#player1balls, #player1escBalls").hide(),$("#player2balls, #player2escBalls").show()):$("#player1balls, #player2balls").hide()}},resize:function(){if(this.width!=window.innerWidth||this.height!=window.innerHeight){this.renderer.setSize(window.innerWidth,window.innerHeight),$("#world canvas").css("width",window.innerWidth+"px").css("height",window.innerHeight+"px"),this.width=window.innerWidth,this.height=window.innerHeight,this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix();var e=$(window).width(),t=$(window).height();$("#ballsplace").height();$("#player1balls,  #player2balls, #player1escBalls, #player2escBalls").width($("#ballsplace").width()),$("#curTurn").width($("#ballsplace").width());var a=void 0,i=void 0;i=a=this.width>this.height?.7*this.height:.9*this.width,$("#mainmenu").width(i).height(a).css("left",(e-i)/2+"px").css("top",(t-a)/2+"px");var o=$("#mainmenu").height(),l=.8*o;o=(l=Math.min(l,e))/.8,$("#gameEnd").width(l).css("left",(e-l)/2+"px").css("top",(t-o)/2+"px");var n=$("#sound").width();$("#sound, #exit, #restart, #fullScreen").height(n),device.mobile()||device.tablet()?($("#exit").css("right",.2*n+"px"),$("#restart").css("right",1.4*n+"px")):($("#sound").css("right",.2*n+"px"),$("#exit").css("right",1.4*n+"px"),$("#restart").css("right",2.6*n+"px")),device.mobile()&&$("#hitRound, #roundDummy").height("13%"),$("#hitRound, #roundDummy").css("margin-left",-$("#hitRound").width()/2+"px");var s=.08488063660477453;device.mobile()&&($("#hitRound").height("13%"),s*=2.5),$("#roundDummy").width($("#hitRound").width()).height($("#hitRound").height()),$("#hitLine").width($("#hitLine").height()*s),$("#hitLine").css("margin-left",-$("#hitLine").width()/2+"px");$("#exit2").width();$("#exit2, #restart2").height(n),$("#mode_wrap").css("height","20%");var r=-$("#howToPlay").width()/2;1.2*$("#fullScreen").width()>(this.width-$("#howToPlay").width())/2&&(r+=1.2*$("#fullScreen").width()-(this.width-$("#howToPlay").width())/2),console.log(r),$("#howToPlay").css("margin-left",r+"px"),$("#powerBorder, #powerWrap").css("margin-bottom",-$("#powerBorder").height()/2).width(.132*$("#powerBorder").height()),$("#power").css("background-size",$("#powerBorder").width()+"px "+$("#powerBorder").height()+"px"),this.resizeBallsGui()}},cursorUpdate:function(e,t){this.hit||this.rotation?device.mobile()||device.tablet()||($("canvas").removeClass("cursorCueHover"),this.hit?$("canvas").addClass("cursorHit"):$("canvas").removeClass("cursorHit"),this.rotation?$("canvas").addClass("cursorRot"):$("canvas").removeClass("cursorRot")):device.mobile()||device.tablet()||!this.cueWrap.visible||($("canvas").removeClass("cursorHit"),$("canvas").removeClass("cursorRot"),this.rc.setFromCamera(new THREE.Vector3(e/window.innerWidth*2-1,-t/window.innerHeight*2+1,.9),this.camera),this.rc.far=2e4,this.rc.intersectObject(this.cue.children[0]).length?$("canvas").addClass("cursorCueHover"):$("canvas").removeClass("cursorCueHover"))},mouseMove:function(e,t){if(this.controls&&eightballgame&&"gameover"!=eightballgame.state&&(0!==this.curMode||2!=eightballgame.getPlayerId())){if(this.cursorUpdate(e,t),this.rotation){var a=this.mousePos.x-e;this.mousePos.x=e,this.mousePos.y=t,this.cam_rot[eightballgame.getPlayerId()]+=a/this.width*(device.mobile()?90:180),this.mainBall.respown&&(this.cam_rot[eightballgame.getPlayerId()]=Math.min(270,this.cam_rot[eightballgame.getPlayerId()]),this.cam_rot[eightballgame.getPlayerId()]=Math.max(90,this.cam_rot[eightballgame.getPlayerId()]))}if(this.cue.position.z=50*this.cueShift,this.hit){var i=window.innerHeight-40*window.innerHeight/100;$("#hitRound").height();if(i<t){var o=(t-i)/(40*this.height/100);this.cue.position.z=-30*o,$("#hitLine div").height(100*o+"%"),$("#power").height($("#powerBorder").height()*o+"px")}}}},updateCam:function(){if(this.mainBall&&eightballgame){var e=this.cam_rot[eightballgame.getPlayerId()]*Math.PI/180,t=50*Math.cos(e),a=50*Math.sin(e);0===this.curMode&&2==eightballgame.getPlayerId()||this.mainBall.active||"gameover"==eightballgame.state?(this.width>this.height?this.camera.position.set(0,150,50):this.camera.position.set(-100,300,0),this.camera.lookAt(new THREE.Vector3),this.cueWrap.position.copy(this.mainBall.mesh.position),this.cueWrap.position.x+=t,this.cueWrap.position.z+=a,this.cueWrap.position.y=5):(this.camera.position.copy(this.mainBall.mesh.position),this.camera.position.x+=t,this.camera.position.z+=a,this.width<this.height?this.camera.position.y+=25:this.camera.position.y+=32,this.camera.lookAt(this.mainBall.mesh.position),this.cueWrap.position.copy(this.camera.position),this.width<this.height?this.cueWrap.position.y=20:this.cueWrap.position.y=25),this.cueWrap.lookAt(this.mainBall.mesh.position)}},isMyTurn:function(){return 0==this.curMode&&1==eightballgame.getPlayerId()||1==this.curMode},mouseClick:function(e,t){if(this.controls&&"gameover"!=eightballgame.state){this.hit=!1,this.rotation=!0;var a=window.innerWidth/2-$("#hitRound").width()/2,i=window.innerWidth/2+$("#hitRound").width()/2,o=window.innerHeight-40*window.innerHeight/100,l=o-$("#hitRound").height();if(this.cueWrap.visible)if(l<=t&&t<=o&&a<=e&&e<=i){this.hit=!0,$("#powerBorder, #powerWrap").show(),$("#power").height(0),this.rotation=!1;$("#hitRound").width();var n=$("#hitRound").height(),s=40*this.height/100+n/2;$("#hitAnim").width(1.9*$("#hitRound").width()+"px"),$("#hitAnim").height(1.9*$("#hitRound").height()+"px"),$("#hitAnim").css("margin-left",-$("#hitAnim").width()/2+"px").css("bottom",s+"px").css("margin-bottom",-$("#hitAnim").height()/2+"px"),$("#hitAnim").show(),$("#hitAnim div").addClass("round")}else this.mousePos.x=e;this.mousePos.y=t}},mouseUp:function(e,t){if(this.controls&&"gameover"!=eightballgame.state){if($("#hitAnim").hide(),$("#hitAnim div").removeClass("round"),this.hit){var a=window.innerHeight-40*window.innerHeight/100;$("#hitRound").height();if(this.cueWrap.visible&&a<t){var i=90*(t-a)/(40*this.height/100),o=new THREE.Vector3;o.copy(this.mainBall.mesh.position).sub(this.cueWrap.position),o.y=0,o.normalize(),this.mainBall.forward.copy(o),this.mainBall.hitForward(i),eightballgame.hitButtonClicked();var l=.5<Math.random()?"hitcue05":"hitcue06";this.mute||document.getElementById(l).play()}}this.cue.position.z=0,this.rotation=!1,this.hit=!1,$("#powerBorder, #powerWrap").hide(),$("#hitLine div").height(0),device.mobile()||device.tablet()||($("canvas").removeClass("cursorHit"),$("canvas").removeClass("cursorRot"))}},setLastTurn:function(e,t,a,i){2===a?this.lastTurn2[0]==e&&this.lastTurn2[1]==t||(this.lastTurn2=[e,t],this.lastTurnTimer2=0,this.lastTurnTotalTimer2=0,i||(this.needsUpdateLast2=!0)):this.lastTurn1[0]==e&&this.lastTurn1[1]==t||(this.lastTurn1=[e,t],this.lastTurnTimer1=0,this.lastTurnTotalTimer1=0,i||(this.needsUpdateLast1=!0))},newgame:function(){if(eightballgame){for(var e in eightballgame.timeouts)clearTimeout(eightballgame.timeouts[e]);clearInterval(eightballgame.hitInt)}for(var t in this.cam_rot={1:180+Math.random(),2:180+Math.random()},eightballgame=new EightBallGame,this.startTimer(),this.lastTurn1=[-1,-1],this.lastTurn2=[-1,-1],this.lastTurnTimer1=0,this.lastTurnTimer2=0,this.gameOverTotalTimer=-1,this.lastTurnTotalTimer1=0,this.lastTurnTotalTimer2=0,this.gameover=!1,this.currentPlayer=1,this.balls)this.scene.remove(this.balls[t].mesh),this.world.remove(this.balls[t].rigidBody);this.balls={},this.mainBall&&(this.scene.remove(this.mainBall.mesh),this.scene.remove(this.mainBall.forwardLine),this.world.remove(this.mainBall.rigidBody)),this.mainBall=null,this.mainBall=new WhiteBall;for(var a=Ball.RADIUS,i=[[8*a,-4*a],[2*a,a],[4*a,-2*a],[8*a,2*a],[6*a,-a],[8*a,-2*a],[6*a,3*a],[4*a,0],[6*a,-3*a],[6*a,a],[8*a,4*a],[4*a,2*a],[8*a,0],[2*a,-a],[0,0]],o=1;o<16;o++)this.balls[o]=new Ball(40+i[15-o][0]-25,5,i[15-o][1],o)},setMode:function(e){if(this.controls=!0,this.curMode=e,this.newgame(),$("#mainmenu").fadeOut(),$("#timer").fadeIn(),$("#restart, #exit").fadeIn(),$("#curTurn").fadeIn(),$("#ballsplace ").fadeIn(),$("#howToPlay").hide(),0===e&&(this.bot=new Bot),eightballgame.startTurn(),!this.help){this.controls=!1;var t=setInterval(function(){Game.mainBall.active||(setTimeout(function(){$("#hand").show().animate({left:"49%",bottom:"39%"},1e3).promise().done(function(){$("#hitRound").width();var e=$("#hitRound").height(),t=40*Game.height/100+e/2;$("#hitAnim").width(1.9*$("#hitRound").width()+"px"),$("#hitAnim").height(1.9*$("#hitRound").height()+"px"),$("#hitAnim").css("margin-left",-$("#hitAnim").width()/2+"px").css("bottom",t+"px").css("margin-bottom",-$("#hitAnim").height()/2+"px"),$("#hitAnim").show(),$("#powerWrap, #powerBorder").show(),$("#hitAnim div").addClass("round");var a=this;setTimeout(function(){$(a).animate({left:"49%",bottom:"1%"},{duration:1500,step:function(e,t){if(e<40){var a=(39-e)/39;Game.cue.position.z=-30*a,$("#hitLine div").height(100*a+"%"),$("#power").height($("#powerBorder").height()*a+"px")}}}).promise().done(function(){$("#hitAnim").hide(),$("#powerWrap, #powerBorder").hide(),$("#hitAnim div").removeClass("round"),$(this).hide(),Game.cue.position.z=0,$("#hitLine div").height(0),$("#power").height(0),Game.controls=!0})},500)})},1e3),this.help=!0,clearInterval(t))},10)}},setMute:function(){this.mute?(this.mute=!1,$("#line").hide()):(this.mute=!0,$("#line").show())},getTimer:function(){var e=Date.now()-this.startTime,t=new Date(e),a=t.getUTCHours();a<10&&(a="0"+a);var i=t.getMinutes();i<10&&(i="0"+i);var o=t.getSeconds();return o<10&&(o="0"+o),i+":"+o},startTimer:function(){this.timer&&(this.stopTimer(),$("#timer span").text("00:00")),this.startTime=Date.now(),this.timer=setInterval(function(){$("#timer span").text(this.getTimer())}.bind(this),200)},stopTimer:function(){this.timer&&clearInterval(this.timer)},loaded:function(){this.loadingcount--,console.log(this.loadingcount),this.loadingcount<=0&&$("#loader_bg").hide()},onclick:function(){},fullScreen:function(){if(document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement)document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen();else{var e=document.documentElement;e.requestFullScreen?e.requestFullScreen(e):e.webkitRequestFullScreen?e.webkitRequestFullScreen(e.ALLOW_KEYBOARD_INPUT):e.mozRequestFullScreen&&e.mozRequestFullScreen(e)}},nextTurn:function(){this.curTurn+=1,2<this.curTurn&&(this.curTurn=1)},over:function(e){0===this.curMode?"player1"==e?($("#line1").text("Congratilations!"),$("#line2").text("You WIN"),this.mute||document.getElementById("ending").play()):($("#line1").text("You Lose"),$("#line2").text("Try again!")):("player1"==e?$("#line1").text("Player 1 WIN"):$("#line1").text("Player 2 WIN"),this.mute||document.getElementById("ending").play(),$("#line2").text("Try again!")),$("#gameTime").text(this.getTimer()),$("#gameEnd").fadeIn(),this.controls=!1},isColTouche:function(e){if(e.length<=1)return!1;for(var t in e)if(11<e[t])return!1;return!0},resizeBallsGui:function(){var e=$("#ballsplace").height();$("#player1balls img, #player2balls img, #player1escBalls img, #player2escBalls img, #player1escBalls div, #player2escBalls div").css("width",.65*e+"px").css("height",.65*e+"px").css("border-radius",.65*e/2+"px")},updateBallsGui:function(){if($("#player1balls, #player2balls, #player1escBalls, #player2escBalls").html(""),"?"!=eightballgame.sides.player1){var e=void 0,t=void 0,a=void 0,i=void 0;for(var o in"solid"==eightballgame.sides.player1?(e="#player1balls",t="#player2balls",a="#player1escBalls",i="#player2escBalls"):(e="#player2balls",t="#player1balls",i="#player1escBalls",a="#player2escBalls"),eightballgame.solidDrop){var l=$("<img/>");if($(l).attr("src",this.ballTextures[eightballgame.solidDrop[o]].image.toDataURL()),$(e).append(l),-1!=eightballgame.escSolid.indexOf(eightballgame.solidDrop[o])){var n=$("<img/>");$(n).attr("src","img/redx.png"),$(a).append(n)}else $(a).append("<div/>")}for(var s in eightballgame.stripedDrop){var r=$("<img/>");if($(r).attr("src",this.ballTextures[eightballgame.stripedDrop[s]].image.toDataURL()),$(t).append(r),-1!=eightballgame.escStriped.indexOf(eightballgame.stripedDrop[s])){var h=$("<img/>");$(h).attr("src","img/redx.png"),$(i).append(h)}else $(i).append("<div/>")}}this.resizeBallsGui()}};$(document).ready(function(){Game.init(),setControls(),$("#mode0").click(function(){Game.setMode(0),Game.onclick()}),$("#mode1").click(function(){Game.setMode(1),Game.onclick()}),$("#mainmenu").fadeIn(),$("#sound").click(function(){Game.setMute()}),$("#restart, #restart2").click(function(){eightballgame&&eightballgame.hitInt&&clearInterval(eightballgame.hitInt),Game.newgame(),$("#gameEnd").fadeOut(),Game.onclick(),Game.controls=!0}),$("#exit, #exit2").click(function(){Game.controls=!1,$("#mainmenu").fadeIn(),$("#timer").fadeOut(),$("#restart, #exit").fadeOut(),$("#curTurn").fadeOut(),$("#gameEnd").fadeOut(),$("#howToPlay").show(),Game.bot=null,clearInterval(eightballgame.hitInt),eightballgame=null,Game.onclick(),$("#player1balls, #player2balls, #ballsplace ").hide()}),$("#fullScreen").click(function(){Game.fullScreen()}).show(),(device.mobile()||device.tablet())&&(Game.setMute(),$("#sound").hide()),config.fullscreen||$("#fullScreen").hide()});